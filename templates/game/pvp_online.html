{% extends "base.html" %}

{% block title %}Online PvP - Super Tic-Tac-Toe{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/developer-theme.css') }}?v=17">
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<style>
/* Override matrix rain colors to green */
.binary-char {
    color: rgba(34, 197, 94, 0.4) !important;
    text-shadow: 0 0 5px rgba(34, 197, 94, 0.3) !important;
}

@keyframes binaryFall {
    0% {
        transform: translateY(0);
        opacity: 0;
        color: rgba(34, 197, 94, 0.6) !important;
        text-shadow: 0 0 8px rgba(34, 197, 94, 0.4) !important;
    }
    5% {
        opacity: 1;
        color: rgba(34, 197, 94, 0.5) !important;
        text-shadow: 0 0 6px rgba(34, 197, 94, 0.3) !important;
    }
    50% {
        opacity: 0.8;
        color: rgba(34, 197, 94, 0.4) !important;
        text-shadow: 0 0 4px rgba(34, 197, 94, 0.2) !important;
    }
    85% {
        opacity: 0.6;
        color: rgba(34, 197, 94, 0.3) !important;
        text-shadow: 0 0 2px rgba(34, 197, 94, 0.1) !important;
    }
    100% {
        transform: translateY(100vh);
        opacity: 0;
        color: rgba(34, 197, 94, 0.1) !important;
        text-shadow: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Matrix Rain Background (only shows during gameplay) -->
<div class="binary-bg" id="binary-background" style="z-index: -999; pointer-events: none; position: fixed; display: none;"></div>

<div class="dev-container">
    <!-- Game Header -->
    <div class="dev-game-header">
        <h1 class="dev-game-title">
            > super_tic_tac_toe --mode=online_pvp
        </h1>

    </div>



    <!-- Room Management Section -->
    <div id="lobby-section" class="dev-game-section">
        <div class="mode-card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(22, 163, 74, 0.02) 100%); border: 1px solid rgba(34, 197, 94, 0.15); padding: 2.5rem; border-radius: 8px; transition: all 0.3s ease; max-width: 800px; margin: 0 auto;">
            <h2 class="mono" style="color: var(--dev-white); font-size: 1.5rem; margin-bottom: 2rem; display: flex; align-items: center;">
                <i class="fas fa-users" style="color: var(--dev-blue-light); margin-right: 0.75rem;"></i>
                Online Multiplayer
            </h2>
            
            <!-- Simple Two-Button Layout -->
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                
                <!-- Create Room Button -->
                <div class="mp-stat" style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; background: rgba(34, 197, 94, 0.08); border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.2); transition: all 0.2s ease; cursor: pointer;"
                     onmouseover="this.style.background='rgba(34, 197, 94, 0.12)'; this.style.transform='scale(1.02)'"
                     onmouseout="this.style.background='rgba(34, 197, 94, 0.08)'; this.style.transform='scale(1)'"
                     id="create-room-btn">
                    <div>
                        <div class="mono" style="color: var(--dev-green); font-size: 1.1rem; margin-bottom: 0.25rem;">
                            <i class="fas fa-plus" style="margin-right: 0.5rem;"></i>Create New Room
                        </div>
                        <div class="mono" style="color: var(--dev-text-gray); font-size: 0.8rem;">Start a new game and invite friends</div>
                    </div>
                </div>

                <!-- Join Room Section -->
                <div class="mp-stat" style="padding: 1.25rem; background: rgba(251, 191, 36, 0.08); border-radius: 6px; border: 1px solid rgba(251, 191, 36, 0.2); transition: all 0.2s ease;">
                    <div class="mono" style="color: var(--dev-yellow); font-size: 1rem; margin-bottom: 1rem;">
                        <i class="fas fa-sign-in-alt" style="margin-right: 0.5rem;"></i>Join Existing Room
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <input type="text" id="room-code-input" placeholder="Enter room code" class="mono" 
                               style="flex: 1; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--dev-white); padding: 0.75rem 1rem; border-radius: 4px; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;">
                        <button id="join-room-btn" class="mono" 
                                style="background: var(--dev-yellow); color: var(--dev-black); border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.2s ease;">
                            Join
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Simple Info -->
            <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: rgba(168, 85, 247, 0.08); border: 1px solid rgba(168, 85, 247, 0.2); border-radius: 6px;">
                <div class="mono" style="color: var(--dev-text-gray); font-size: 0.9rem;">
                    Real-time multiplayer â€¢ Share room codes with friends
                </div>
            </div>
        </div>
    </div>

    <!-- Room Info Section (Hidden initially) -->
    <div id="room-section" class="dev-game-section" style="display: none;">
        <div class="mode-card" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.05) 0%, rgba(22, 163, 74, 0.02) 100%); border: 1px solid rgba(34, 197, 94, 0.15); padding: 2.5rem; border-radius: 8px; transition: all 0.3s ease; max-width: 700px; margin: 0 auto;">
                         <h2 class="mono" style="color: var(--dev-white); font-size: 1.5rem; margin-bottom: 2rem; display: flex; align-items: center; justify-content: space-between;">
                 <div style="display: flex; align-items: center;">
                     <i class="fas fa-door-open" style="color: var(--dev-blue-light); margin-right: 0.75rem;"></i>
                     Room: <span id="current-room-code" style="color: var(--dev-blue-light); margin-left: 0.5rem; font-weight: bold; letter-spacing: 2px; font-size: 1.5rem;">------</span>
                 </div>
                 <button id="copy-room-code-btn" class="mono" 
                         style="background: rgba(59, 130, 246, 0.08); color: var(--dev-blue); border: 1px solid rgba(59, 130, 246, 0.2); padding: 0.5rem 1rem; 
                                border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;"
                         onmouseover="this.style.background='rgba(59, 130, 246, 0.12)'"
                         onmouseout="this.style.background='rgba(59, 130, 246, 0.08)'">
                     <i class="fas fa-copy" style="margin-right: 0.5rem;"></i>
                     Copy
                 </button>
             </h2>
            
            <div style="display: flex; flex-direction: column; gap: 1rem; flex: 1;">
                <!-- Player 1 Slot (Green) -->
                <div class="mp-stat" id="player1-slot" style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; background: rgba(34, 197, 94, 0.08); border-radius: 6px; border: 1px solid rgba(34, 197, 94, 0.2); transition: all 0.2s ease;"
                     onmouseover="this.style.background='rgba(34, 197, 94, 0.12)'; this.style.transform='scale(1.02)'"
                     onmouseout="this.style.background='rgba(34, 197, 94, 0.08)'; this.style.transform='scale(1)'">
                                         <div>
                         <div class="mono" style="color: var(--dev-green); font-size: 1rem; margin-bottom: 0.25rem;">
                             <i class="fas fa-user-circle" style="margin-right: 0.5rem;"></i>Host
                         </div>
                     </div>
                                         <div style="text-align: right;">
                                                   <div class="mono" style="color: var(--dev-green); font-size: 1.5rem; font-weight: 600;" id="player1-name">[null]</div>
                     </div>
                </div>
                
                                 <!-- Player 2 Slot (Yellow) -->
                 <div class="mp-stat" id="player2-slot" style="display: flex; justify-content: space-between; align-items: center; padding: 1.25rem; background: rgba(251, 191, 36, 0.08); border-radius: 6px; border: 1px solid rgba(251, 191, 36, 0.2); transition: all 0.2s ease;"
                      onmouseover="this.style.background='rgba(251, 191, 36, 0.12)'; this.style.transform='scale(1.02)'"
                      onmouseout="this.style.background='rgba(251, 191, 36, 0.08)'; this.style.transform='scale(1)'">
                                          <div>
                          <div class="mono" style="color: var(--dev-yellow); font-size: 1rem; margin-bottom: 0.25rem;">
                              <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i>Guest
                          </div>
                      </div>
                                          <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <div class="mono" style="color: var(--dev-yellow); font-size: 1.5rem; font-weight: 600;" id="player2-name">[null]</div>
                                                    <button id="kick-player-btn" class="mono" 
                                                            style="background: rgba(239, 68, 68, 0.08); color: var(--dev-red); border: 1px solid rgba(239, 68, 68, 0.2); padding: 0.25rem 0.5rem; 
                                                                   border-radius: 4px; font-size: 0.7rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: none;"
                                                            onmouseover="this.style.background='rgba(239, 68, 68, 0.12)'"
                                                            onmouseout="this.style.background='rgba(239, 68, 68, 0.08)'"
                                                            title="Kick player">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                      </div>
                 </div>
                
                                                                   <!-- Room Action Buttons -->
                  <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1rem;">
                      <button id="start-game-btn" class="mono" 
                              style="background: rgba(34, 197, 94, 0.08); color: var(--dev-green); border: 1px solid rgba(34, 197, 94, 0.2); padding: 0.75rem 1.5rem; 
                                     border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; opacity: 0.5; display: none;"
                              onmouseover="if(this.style.opacity !== '0.5') this.style.background='rgba(34, 197, 94, 0.12)'"
                              onmouseout="if(this.style.opacity !== '0.5') this.style.background='rgba(34, 197, 94, 0.08)'"
                              disabled>
                          <i class="fas fa-play" style="margin-right: 0.5rem;"></i>
                          Start Game
                      </button>
                      <button id="leave-room-btn" class="mono" 
                              style="background: rgba(239, 68, 68, 0.08); color: var(--dev-red); border: 1px solid rgba(239, 68, 68, 0.2); padding: 0.75rem 1.5rem; 
                                     border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease;"
                              onmouseover="this.style.background='rgba(239, 68, 68, 0.12)'"
                              onmouseout="this.style.background='rgba(239, 68, 68, 0.08)'">
                          <i class="fas fa-sign-out-alt" style="margin-right: 0.5rem;"></i>
                          Leave Room
                      </button>
                  </div>
            </div>
        </div>
    </div>

    <!-- Game Status -->
    <div id="game-status" class="dev-game-status" style="display: none;"></div>

    <!-- Game Board (Hidden initially) -->
    <div id="game-section" class="dev-game-section" style="display: none;">
        <div class="dev-game-container">
            <div id="board" class="dev-game-board"></div>
        </div>
        
        <!-- Game Controls -->
        <div class="dev-game-controls">
            <!-- Removed Back to Lobby button to prevent mid-game confusion -->
        </div>
    </div>


</div>


<script>
 // Game state variables
 let socket = null;
 let currentRoom = null;
 let gameState = null;
 let playerNumber = null;
 let gameBoard = null;
 let currentBoard = null;
 let gameOver = false;
 let legalMoves = [];
 let isHost = false;

// DOM elements
const lobbySection = document.getElementById('lobby-section');
const roomSection = document.getElementById('room-section');
const gameSection = document.getElementById('game-section');
const gameStatus = document.getElementById('game-status');
const boardContainer = document.getElementById('board');

   // Buttons
  const createRoomBtn = document.getElementById('create-room-btn');
  const joinRoomBtn = document.getElementById('join-room-btn');
  const roomCodeInput = document.getElementById('room-code-input');
     const leaveRoomBtn = document.getElementById('leave-room-btn');
   const startGameBtn = document.getElementById('start-game-btn');
   const copyRoomCodeBtn = document.getElementById('copy-room-code-btn');
   const kickPlayerBtn = document.getElementById('kick-player-btn');



// Initialize Socket.IO connection
function initializeSocket() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('Connected to server');
    });
    
    socket.on('disconnect', function() {
        console.log('Disconnected from server');
    });
    
    socket.on('error', function(data) {
        showMessage(data.message, 'error');
    });
    
         socket.on('room_created', function(data) {
         currentRoom = data.room_code;
         isHost = true; // Room creator is always the host
         playerNumber = 1;
         // When creating a room, you are player 1
         showRoomSection(data.room_code, data.creator_name || 'You');
         showMessage(`Room ${data.room_code} created! Share this code with your friend.`, 'success');
         
         // Show start button for host (disabled until second player joins)
         startGameBtn.style.display = 'block';
         startGameBtn.disabled = true;
         startGameBtn.style.opacity = '0.5';
         startGameBtn.style.cursor = 'not-allowed';
     });
    
                                                                               socket.on('room_joined', function(data) {
            currentRoom = data.room_code;
            
            // Only update playerNumber if this is the first time joining (not a notification)
            if (!playerNumber) {
                playerNumber = data.player_number;
                isHost = (data.player_number === 1); // Player 1 is always the host
                console.log(`Set playerNumber=${playerNumber}, isHost=${isHost}`);
            }
            
            showRoomSection(data.room_code);
            
            // Update player names if provided
            if (data.player1_name) {
                document.getElementById('player1-name').textContent = data.player1_name;
            }
            if (data.player2_name) {
                document.getElementById('player2-name').textContent = data.player2_name;
            }
            
                         // Check if both players are present and enable start button for host
             const player1Name = document.getElementById('player1-name').textContent;
             const player2Name = document.getElementById('player2-name').textContent;
             
             if (player1Name !== '[null]' && player2Name !== '[null]' && isHost) {
                 enableStartButton();
                 // Show kick button for host when guest is present
                 kickPlayerBtn.style.display = 'block';
             } else if (isHost) {
                 // If host but only one player, show button but disabled
                 startGameBtn.style.display = 'block';
                 startGameBtn.disabled = true;
                 startGameBtn.style.opacity = '0.5';
                 startGameBtn.style.cursor = 'not-allowed';
                 kickPlayerBtn.style.display = 'none';
             }
            
            if (data.opponent) {
                showMessage(`Joined room ${data.room_code}! Playing against ${data.opponent}`, 'success');
            } else {
                showMessage(data.message || 'Joined room successfully', 'info');
            }
        });
    
    socket.on('game_started', function(data) {
        gameState = data;
        showGameSection();
        updateGameBoard(data);
        showMessage(`Game started! ${data.player1} vs ${data.player2}`, 'success');
        
        // Show initial game status
        updateGameStatus(data);
        
        // Start matrix rain during gameplay
        startMatrixRain();
    });
    
    socket.on('move_made', function(data) {
        updateGameBoard(data);
    });
    
    socket.on('game_ended', function(data) {
        gameOver = true;
        showMessage(data.message, data.winner === 0 ? 'info' : 'success');
    });
    
    socket.on('game_reset', function(data) {
        gameOver = false;
        updateGameBoard(data);
        showMessage('Game reset! New round starting...', 'info');
    });
    
    socket.on('player_disconnected', function(data) {
        showMessage(`${data.username} disconnected`, 'warning');
        
        // Show a persistent flashcard for disconnect
        showDisconnectFlashcard(data.username, data.room_code);
    });
    
         socket.on('player_rejoined', function(data) {
         showMessage(data.message, 'success');
         hideDisconnectFlashcard();
     });
     
     socket.on('player_kicked', function(data) {
         showMessage(data.message, 'warning');
         if (data.message.includes('You have been kicked')) {
             // If we were kicked, return to lobby
             showLobbySection();
         } else {
             // If we kicked someone, update the UI
             document.getElementById('player2-name').textContent = '[null]';
             // Show start button but keep it disabled (waiting for new player)
             startGameBtn.style.display = 'block';
             startGameBtn.disabled = true;
             startGameBtn.style.opacity = '0.5';
             startGameBtn.style.cursor = 'not-allowed';
             kickPlayerBtn.style.display = 'none';
         }
     });
     
     socket.on('left_room', function(data) {
         showLobbySection();
         showMessage('Left the room', 'info');
     });
     
     // Handle when room is closing (host left)
     socket.on('room_closing', function(data) {
         showMessage(data.message, 'warning');
         // Auto-return to lobby after a short delay
         setTimeout(() => {
             showLobbySection();
         }, 2000);
     });
     
     // Handle when room doesn't exist (e.g., host left and room was deleted)
     socket.on('room_not_found', function(data) {
         showLobbySection();
         showMessage('Room no longer exists', 'warning');
     });
     
     // Handle when host disconnects (for guests)
     socket.on('player_disconnected', function(data) {
         showMessage(`${data.username} disconnected`, 'warning');
         
         // If host disconnected and we're a guest, auto-return to lobby after delay
         if (!isHost && data.username === document.getElementById('player1-name').textContent) {
             setTimeout(() => {
                 showLobbySection();
                 showMessage('Host left the room. Returning to lobby.', 'warning');
             }, 3000);
         } else {
             // Show a persistent flashcard for disconnect
             showDisconnectFlashcard(data.username, data.room_code);
         }
     });
}



function showMessage(message, type = 'info') {
    // Reuse flash message system from base template
    const messageDiv = document.createElement('div');
    messageDiv.className = `mono flash-message`;
    messageDiv.style.cssText = `
        position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 1000;
        background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);
        color: var(--dev-white); padding: 1rem 1.5rem; border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3); border: 1px solid rgba(255, 255, 255, 0.2);
        font-size: 0.95rem; text-align: center; opacity: 0; animation: fadeIn 0.5s ease-out forwards;
    `;
    
    const icon = type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle';
    messageDiv.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
    
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.style.animation = 'fadeOut 0.5s ease-out forwards';
        setTimeout(() => messageDiv.remove(), 500);
    }, 3000);
}

function showDisconnectFlashcard(username, roomCode) {
    hideDisconnectFlashcard(); // Remove any existing flashcard
    
    const flashcard = document.createElement('div');
    flashcard.id = 'disconnect-flashcard';
    flashcard.className = 'mono';
    flashcard.style.cssText = `
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000;
        background: rgba(255, 69, 0, 0.9); backdrop-filter: blur(15px);
        color: white; padding: 2rem 2.5rem; border-radius: 12px;
        box-shadow: 0 12px 32px rgba(255, 69, 0, 0.4); border: 2px solid rgba(255, 255, 255, 0.3);
        font-size: 1.1rem; text-align: center; max-width: 400px;
        opacity: 0; animation: fadeIn 0.5s ease-out forwards;
    `;
    
    flashcard.innerHTML = `
        <div style="margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #fff;"></i>
        </div>
        <h3 style="margin: 0 0 1rem 0; font-size: 1.3rem;">Player Disconnected</h3>
        <p style="margin: 0 0 1.5rem 0; font-size: 1rem; opacity: 0.9;">
            <strong>${username}</strong> has left the game.<br/>
            They can rejoin using room code: <br/>
            <span style="font-size: 1.4rem; font-weight: bold; color: #ffff00;">${roomCode}</span>
        </p>
        <p style="margin: 0; font-size: 0.9rem; opacity: 0.8;">
            Waiting for them to return...
        </p>
    `;
    
    document.body.appendChild(flashcard);
}

function hideDisconnectFlashcard() {
    const existing = document.getElementById('disconnect-flashcard');
    if (existing) {
        existing.style.animation = 'fadeOut 0.5s ease-out forwards';
        setTimeout(() => existing.remove(), 500);
    }
}

function showRoomSection(roomCode, player1Name = null, player2Name = null) {
    document.getElementById('current-room-code').textContent = roomCode;
    
    // Update player names if provided
    if (player1Name) {
        document.getElementById('player1-name').textContent = player1Name;
    }
    if (player2Name) {
        document.getElementById('player2-name').textContent = player2Name;
    }
    
    lobbySection.style.display = 'none';
    roomSection.style.display = 'block';
}

function showGameSection() {
    roomSection.style.display = 'none';
    gameSection.style.display = 'block';
    gameStatus.style.display = 'block';
}

   function showLobbySection() {
      roomSection.style.display = 'none';
      gameSection.style.display = 'none';
      gameStatus.style.display = 'none';
      
      // Stop matrix rain when returning to lobby
      stopMatrixRain();
      lobbySection.style.display = 'block';
      currentRoom = null;
      playerNumber = null;
      isHost = false;
      disableStartButton();
      kickPlayerBtn.style.display = 'none';
  }
 
   function enableStartButton() {
      if (isHost) {
          startGameBtn.style.display = 'block';
          startGameBtn.disabled = false;
          startGameBtn.style.opacity = '1';
          startGameBtn.style.cursor = 'pointer';
      }
  }
  
  function disableStartButton() {
      startGameBtn.style.display = 'none';
      startGameBtn.disabled = true;
      startGameBtn.style.opacity = '0.5';
      startGameBtn.style.cursor = 'not-allowed';
  }

function updateGameBoard(data) {
    gameBoard = data.board;
    currentBoard = data.current_board;
    gameOver = data.game_over;
    legalMoves = data.legal_moves || [];
    
    renderBoard(data.board, data.small_status);
    updateGameStatus(data);
}

function renderBoard(board, smallStatus) {
    boardContainer.innerHTML = "";

    for (let bigRow = 0; bigRow < 3; bigRow++) {
        for (let bigCol = 0; bigCol < 3; bigCol++) {
            const bigIndex = bigRow * 3 + bigCol;
            const smallBoard = document.createElement("div");
            smallBoard.className = "dev-small-board";
            smallBoard.id = `small-board-${bigIndex}`;
            
            // Check if this small board is won
            const smallWinner = smallStatus[bigRow][bigCol];
            if (smallWinner === 1) {
                smallBoard.classList.add('won-x');
            } else if (smallWinner === 2) {
                smallBoard.classList.add('won-o');
            }
            
            // Highlight current board
            if (currentBoard && currentBoard[0] === bigRow && currentBoard[1] === bigCol) {
                smallBoard.classList.add('active');
            }

            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    const r = bigRow * 3 + i;
                    const c = bigCol * 3 + j;
                    const val = board[r][c];
                    const cell = document.createElement("div");
                    
                    // Check if this move is legal
                    const isLegal = legalMoves.some(([lr, lc]) => lr === r && lc === c);

                    cell.className = "dev-cell";
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    
                    if (val === 1) {
                        cell.textContent = "1";
                        cell.classList.add('x', 'filled');
                    } else if (val === -1) {
                        cell.textContent = "0";
                        cell.classList.add('o', 'filled');
                    } else if (isLegal && !gameOver) {
                        cell.classList.add('legal');
                        cell.addEventListener("click", handleCellClick);
                    }

                    smallBoard.appendChild(cell);
                }
            }

            boardContainer.appendChild(smallBoard);
        }
    }
}

function updateGameStatus(data) {
    // Get player names from game state
    const player1Name = gameState?.player1 || "Player 1";
    const player2Name = gameState?.player2 || "Player 2";
    
    if (data.game_over) {
        if (data.winner === 1) {
            gameStatus.innerHTML = `<i class="fas fa-trophy"></i> ${player1Name} wins!`;
            gameStatus.className = "dev-game-status status-win";
        } else if (data.winner === -1) {
            gameStatus.innerHTML = `<i class="fas fa-trophy"></i> ${player2Name} wins!`;
            gameStatus.className = "dev-game-status status-win";
        } else {
            gameStatus.innerHTML = '<i class="fas fa-equals"></i> Draw!';
            gameStatus.className = "dev-game-status status-draw";
        }
    } else {
        const currentPlayerName = data.current_player === 1 ? player1Name : player2Name;
        const symbol = data.current_player === 1 ? "1" : "0";
        
        // Fix turn detection: playerNumber is 1 or 2, but game engine uses 1 and -1
        // Player 1 (host) = playerNumber 1 = game engine 1 (PLAYER_X)
        // Player 2 (guest) = playerNumber 2 = game engine -1 (PLAYER_O)
        const myGameEngineValue = playerNumber === 1 ? 1 : -1;
        const isMyTurn = data.current_player === myGameEngineValue;
        const turnText = isMyTurn ? "Your turn" : "Opponent's turn";
        
        // Debug logging
        console.log(`Game status: current_player=${data.current_player}, playerNumber=${playerNumber}, myGameEngineValue=${myGameEngineValue}, isMyTurn=${isMyTurn}`);
        
        gameStatus.innerHTML = `<i class="fas fa-terminal"></i> ${currentPlayerName} (${symbol}) // ${turnText}`;
        gameStatus.className = "dev-game-status status-turn";
    }
}

function handleCellClick(e) {
    if (gameOver || !currentRoom) return;

    const row = parseInt(e.currentTarget.dataset.row);
    const col = parseInt(e.currentTarget.dataset.col);

    socket.emit('make_move', {
        room_code: currentRoom,
        row: row,
        col: col
    });
}

// Event listeners
createRoomBtn.addEventListener('click', function() {
    socket.emit('create_room');
});

joinRoomBtn.addEventListener('click', function() {
    const roomCode = roomCodeInput.value.trim().toUpperCase();
    if (roomCode.length === 6) {
        socket.emit('join_room', { room_code: roomCode });
    } else {
        showMessage('Please enter a valid 6-character room code', 'error');
    }
});

roomCodeInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        joinRoomBtn.click();
    }
});

   leaveRoomBtn.addEventListener('click', function() {
      if (currentRoom) {
          socket.emit('leave_room', { room_code: currentRoom });
          showMessage('Leaving room...', 'info');
      } else {
          // If no current room, just go back to lobby
          showLobbySection();
          showMessage('Returned to lobby', 'info');
      }
  });
 
   startGameBtn.addEventListener('click', function() {
      if (currentRoom && !startGameBtn.disabled) {
          socket.emit('start_game', { room_code: currentRoom });
          showMessage('Starting game...', 'info');
      }
  });
  
     copyRoomCodeBtn.addEventListener('click', function() {
       const roomCode = document.getElementById('current-room-code').textContent;
       if (roomCode && roomCode !== '------') {
           navigator.clipboard.writeText(roomCode).then(function() {
               // Temporarily change button text to show success
               const originalText = copyRoomCodeBtn.innerHTML;
               copyRoomCodeBtn.innerHTML = '<i class="fas fa-check" style="margin-right: 0.5rem;"></i>Copied!';
               copyRoomCodeBtn.style.background = 'rgba(34, 197, 94, 0.12)';
               copyRoomCodeBtn.style.color = 'var(--dev-green)';
               copyRoomCodeBtn.style.borderColor = 'rgba(34, 197, 94, 0.3)';
               
               setTimeout(() => {
                   copyRoomCodeBtn.innerHTML = originalText;
                   copyRoomCodeBtn.style.background = 'rgba(59, 130, 246, 0.08)';
                   copyRoomCodeBtn.style.color = 'var(--dev-blue)';
                   copyRoomCodeBtn.style.borderColor = 'rgba(59, 130, 246, 0.2)';
               }, 2000);
               
               showMessage('Room code copied to clipboard!', 'success');
           }).catch(function(err) {
               showMessage('Failed to copy room code', 'error');
           });
       }
   });
   
   kickPlayerBtn.addEventListener('click', function() {
       if (currentRoom && isHost) {
           if (confirm('Are you sure you want to kick this player?')) {
               socket.emit('kick_player', { room_code: currentRoom });
           }
       }
   });





 // Initialize when page loads
 document.addEventListener('DOMContentLoaded', function() {
     initializeSocket();
     
     // Auto-format room code input
     roomCodeInput.addEventListener('input', function(e) {
         e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
     });
     
           // Periodic check to ensure room still exists (for guests only)
      setInterval(() => {
          if (currentRoom && !isHost && roomSection.style.display !== 'none') {
              // Send a ping to check if room exists
              socket.emit('ping_room', { room_code: currentRoom });
          }
      }, 10000); // Check every 10 seconds
 });


// Matrix Rain Animation (only during gameplay)
function createMatrixRain() {
    const container = document.getElementById('binary-background');
    if (!container) return;
    
    const chars = ['0', '1'];
    const columns = Math.floor(window.innerWidth / 20);
    const drops = [];
    
    // Initialize drops
    for (let i = 0; i < columns; i++) {
        drops[i] = Math.random() * -100;
    }
    
    function createDrop() {
        for (let i = 0; i < columns; i++) {
            if (Math.random() > 0.97) { // Much lower frequency - less crowded
                const char = document.createElement('div');
                char.className = 'binary-char';
                char.textContent = chars[Math.floor(Math.random() * chars.length)];
                char.style.left = (i * 20) + 'px';
                char.style.animationDelay = '0s'; // No delay at all
                char.style.animationDuration = (Math.random() * 3 + 5) + 's'; // Slower, more elegant
                char.style.zIndex = '-999';
                char.style.color = 'rgba(34, 197, 94, 0.4)'; // Green matrix color
                char.style.textShadow = '0 0 5px rgba(34, 197, 94, 0.3)'; // Green glow
                
                // Start some characters at random positions for immediate visibility
                const startPosition = Math.random() > 0.6 ? 
                    Math.random() * -50 + 'vh' :  // Some start closer (immediate visibility)
                    '-100vh';                      // Others start from way up (traditional)
                char.style.top = startPosition;
                
                container.appendChild(char);
                
                // Remove after animation
                setTimeout(() => {
                    if (char.parentNode) {
                        char.parentNode.removeChild(char);
                    }
                }, 8000);
            }
        }
    }
    
    // Create initial drops immediately - fewer of them
    for (let i = 0; i < 3; i++) {
        createDrop();
    }
    
    // Create drops less frequently
    setInterval(createDrop, 120);
}

function startMatrixRain() {
    const container = document.getElementById('binary-background');
    if (container) {
        container.style.display = 'block';
        createMatrixRain();
    }
}

function stopMatrixRain() {
    const container = document.getElementById('binary-background');
    if (container) {
        container.style.display = 'none';
        container.innerHTML = ''; // Clear all matrix characters
    }
}
</script>

<style>
/* Online PvP specific styles */
.status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-family: var(--font-mono);
}

.lobby-option {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border: 1px solid var(--dev-border);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.05);
}

.lobby-option h3 {
    margin: 0 0 0.5rem 0;
    color: var(--dev-blue);
}

.lobby-divider {
    text-align: center;
    margin: 2rem 0;
    color: var(--dev-gray);
    font-family: var(--font-mono);
    font-size: 1.2rem;
}

.join-room-form {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.room-code-input {
    min-width: 150px;
    text-align: center;
    font-family: var(--font-mono);
    font-size: 1.2rem;
    letter-spacing: 0.2em;
}

.room-info {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.player-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.player-slot {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid var(--dev-border);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.05);
    font-family: var(--font-mono);
}

.player-symbol {
    color: var(--dev-blue);
    font-weight: 600;
}

.room-actions {
    display: flex;
    justify-content: center;
}

/* Responsive design */
@media (max-width: 768px) {
    .join-room-form {
        flex-direction: column;
    }
    
    .room-code-input {
        width: 100%;
    }
}
</style>
{% endblock %}
